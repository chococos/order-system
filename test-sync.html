<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæœŸãƒ†ã‚¹ãƒˆï¼ˆReplicationãªã—ï¼‰</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #e8f5e9;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .order-list {
            margin-top: 20px;
        }
        .order-item {
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .order-item h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .order-item p {
            margin: 5px 0;
            color: #666;
        }
        .sync-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .sync-indicator.online {
            background: #4CAF50;
        }
        .sync-indicator.offline {
            background: #f44336;
        }
        .sync-indicator.syncing {
            background: #2196F3;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="sync-info">
        <span class="sync-indicator" id="sync-indicator"></span>
        <span id="sync-status">åˆæœŸåŒ–ä¸­...</span>
    </div>
    
    <div class="container">
        <h1>ğŸ”„ åŒæœŸãƒ†ã‚¹ãƒˆï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ï¼‰</h1>
        
        <div class="status" id="connection-status">
            æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªä¸­...
        </div>
        
        <div>
            <h2>ãƒ†ã‚¹ãƒˆã‚ªãƒ¼ãƒ€ãƒ¼ä½œæˆ</h2>
            <input type="text" id="customer-name" placeholder="é¡§å®¢å" value="ãƒ†ã‚¹ãƒˆé¡§å®¢">
            <input type="text" id="phone" placeholder="é›»è©±ç•ªå·" value="090-1234-5678">
            <textarea id="notes" placeholder="å‚™è€ƒ" rows="3">ãƒ†ã‚¹ãƒˆã‚ªãƒ¼ãƒ€ãƒ¼</textarea>
            
            <button onclick="createOrder()">ã‚ªãƒ¼ãƒ€ãƒ¼ä½œæˆ</button>
            <button onclick="loadOrders()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
            <button onclick="clearLocal()">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¯ãƒªã‚¢</button>
            <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>
        
        <div class="order-list">
            <h2>ã‚ªãƒ¼ãƒ€ãƒ¼ä¸€è¦§</h2>
            <div id="orders-container">
                èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>
    </div>
    
    <!-- Supabaseè¨­å®š -->
    <script src="supabase-config.js"></script>
    
    <script>
        let isOnline = false;
        let syncInterval = null;
        
        // åˆæœŸåŒ–
        async function init() {
            console.log('Initializing...');
            
            // Supabaseæ¥ç¶šç¢ºèª
            await testConnection();
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadOrders();
            
            // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆ3ç§’ã”ã¨ï¼‰
            startPolling();
        }
        
        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            const statusEl = document.getElementById('connection-status');
            const indicatorEl = document.getElementById('sync-indicator');
            const syncStatusEl = document.getElementById('sync-status');
            
            try {
                if (!supabase) {
                    throw new Error('SupabaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // ordersãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹
                const { data, error } = await supabase
                    .from('orders')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                isOnline = true;
                statusEl.textContent = 'âœ… Supabaseã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™';
                statusEl.className = 'status success';
                indicatorEl.className = 'sync-indicator online';
                syncStatusEl.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
                
            } catch (error) {
                isOnline = false;
                statusEl.textContent = 'âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message;
                statusEl.className = 'status error';
                indicatorEl.className = 'sync-indicator offline';
                syncStatusEl.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
            }
        }
        
        // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        function startPolling() {
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(async () => {
                if (isOnline) {
                    const indicatorEl = document.getElementById('sync-indicator');
                    const syncStatusEl = document.getElementById('sync-status');
                    
                    indicatorEl.className = 'sync-indicator syncing';
                    syncStatusEl.textContent = 'åŒæœŸä¸­...';
                    
                    await syncData();
                    
                    indicatorEl.className = 'sync-indicator online';
                    syncStatusEl.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
                }
            }, 3000);
        }
        
        // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncData() {
            if (!isOnline) return;
            
            try {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (!error && data) {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨æ¯”è¼ƒã—ã¦æ›´æ–°
                    const localOrders = JSON.parse(localStorage.getItem('test_orders') || '[]');
                    
                    // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
                    const hasNewData = data.length !== localOrders.length || 
                        data.some((serverOrder, index) => {
                            const localOrder = localOrders[index];
                            return !localOrder || serverOrder.id !== localOrder.id ||
                                   new Date(serverOrder.updated_at) > new Date(localOrder.updated_at || 0);
                        });
                    
                    if (hasNewData) {
                        localStorage.setItem('test_orders', JSON.stringify(data));
                        displayOrders(data);
                        console.log('ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚ªãƒ¼ãƒ€ãƒ¼ä½œæˆ
        async function createOrder() {
            const customerName = document.getElementById('customer-name').value;
            const phone = document.getElementById('phone').value;
            const notes = document.getElementById('notes').value;
            
            const newOrder = {
                customer_name: customerName,
                phone: phone,
                email: 'test@example.com',
                delivery_date: new Date().toISOString().split('T')[0],
                delivery_time: '10:00-12:00',
                delivery_address: 'ãƒ†ã‚¹ãƒˆä½æ‰€',
                order_items: JSON.stringify([{name: 'ãƒ†ã‚¹ãƒˆå•†å“', quantity: 1, price: 1000}]),
                total_amount: 1000,
                notes: notes,
                completed: false,
                deleted: false
            };
            
            if (isOnline) {
                try {
                    const { data, error } = await supabase
                        .from('orders')
                        .insert([newOrder])
                        .select();
                    
                    if (error) throw error;
                    
                    alert('ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    await loadOrders();
                    
                } catch (error) {
                    alert('ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            } else {
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
                const localOrders = JSON.parse(localStorage.getItem('test_orders') || '[]');
                newOrder.id = 'local_' + Date.now();
                newOrder.created_at = new Date().toISOString();
                localOrders.unshift(newOrder);
                localStorage.setItem('test_orders', JSON.stringify(localOrders));
                displayOrders(localOrders);
                alert('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚ªãƒ¼ãƒ€ãƒ¼èª­ã¿è¾¼ã¿
        async function loadOrders() {
            if (isOnline) {
                try {
                    const { data, error } = await supabase
                        .from('orders')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    localStorage.setItem('test_orders', JSON.stringify(data));
                    displayOrders(data);
                    
                } catch (error) {
                    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    const localOrders = JSON.parse(localStorage.getItem('test_orders') || '[]');
                    displayOrders(localOrders);
                }
            } else {
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                const localOrders = JSON.parse(localStorage.getItem('test_orders') || '[]');
                displayOrders(localOrders);
            }
        }
        
        // ã‚ªãƒ¼ãƒ€ãƒ¼è¡¨ç¤º
        function displayOrders(orders) {
            const container = document.getElementById('orders-container');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<p>ã‚ªãƒ¼ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-item">
                    <h3>${order.customer_name || 'åå‰ãªã—'}</h3>
                    <p>ğŸ“ ${order.phone || 'é›»è©±ç•ªå·ãªã—'}</p>
                    <p>ğŸ“ ${order.notes || 'å‚™è€ƒãªã—'}</p>
                    <p>ğŸ• ${new Date(order.created_at).toLocaleString('ja-JP')}</p>
                    <p>ID: ${order.id}</p>
                </div>
            `).join('');
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearLocal() {
            if (confirm('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('test_orders');
                loadOrders();
                alert('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', init);
        
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œçŸ¥
        window.addEventListener('online', () => {
            console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ');
            testConnection();
        });
        
        window.addEventListener('offline', () => {
            console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ');
            isOnline = false;
            document.getElementById('sync-indicator').className = 'sync-indicator offline';
            document.getElementById('sync-status').textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
        });
    </script>
</body>
</html>